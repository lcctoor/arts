# æè¿°

ä¸€ä¸ªä¼˜é›…çš„ PostgreSQL ORM ï¼Œæ— é¡»åšæ¨¡å‹æ˜ å°„ã€‚

[æºç ](https://github.com/lcctoor/skk/tree/main/skk/postgre)

# æ•™ç¨‹

æœ¬æ–‡å°†ä»¥ç®€æ´çš„æ–¹å¼å‘ä½ ä»‹ç»æ ¸å¿ƒçŸ¥è¯†ï¼Œè€Œä¸ä¼šè®©ä½ è¢«ç¹ççš„æœ¯è¯­æ‰€æ·¹æ²¡ã€‚

## å®‰è£…

```bash
pip install skk
```

## å¯¼å…¥

```python
import asyncpg
from skk.postgre import DB, mc
```

## åˆ›å»ºORM

```python
class DB_ORM(DB):  
    async def mkconn(self):
        return await asyncpg.connect(
            user = 'postgres',
            password = '123456789',
            database = 'æ³‰å·å¸‚',
            host = 'localhost',
            port = 5432,
        )

db = DB_ORM()        # åº“ORM
sheet = db['å¸Œæœ›å°å­¦']  # è¡¨ORM
```

## åŸºç¡€åŠŸèƒ½ â€”â€” å¢ã€æŸ¥ã€æ”¹ã€åˆ 

ã€å¢ã€æŸ¥ã€æ”¹ã€åˆ ã€‘çš„æ–¹æ³•åç§°åˆ†åˆ«ä¸ºï¼šinsertã€selectã€updateã€delete ã€‚

### ç¤ºä¾‹

```python
row1 = {'å§“å': 'å°ä¸€', 'å¹´é¾„': 11, 'æ€§åˆ«': 'ç”·', 'è§†åŠ›': 4.5, 'ç­¾åˆ°æ—¥æœŸ': '2023-01-11'}
row2 = {'å§“å': 'å°äºŒ', 'å¹´é¾„': 12, 'æ€§åˆ«': 'ç”·', 'è§†åŠ›': 4.6, 'ç­¾åˆ°æ—¥æœŸ': '2023-01-12'}
row3 = {'å§“å': 'å°ä¸‰', 'å¹´é¾„': 13, 'æ€§åˆ«': 'å¥³', 'è§†åŠ›': 4.7, 'ç­¾åˆ°æ—¥æœŸ': '2023-01-13'}
row4 = {'å§“å': 'å°å››', 'å¹´é¾„': 14, 'æ€§åˆ«': 'å¥³', 'è§†åŠ›': 4.8, 'ç­¾åˆ°æ—¥æœŸ': '2023-01-14'}
row5 = {'å§“å': 'å°äº”', 'å¹´é¾„': 15, 'æ€§åˆ«': 'ç”·', 'è§†åŠ›': 4.9, 'ç­¾åˆ°æ—¥æœŸ': '2023-01-15'}
row6 = {'å§“å': 'å°å…­', 'å¹´é¾„': 16, 'æ€§åˆ«': 'å¥³', 'è§†åŠ›': 5.0, 'ç­¾åˆ°æ—¥æœŸ': '2023-01-16'}
```

|    åŠŸèƒ½    | è¯­æ³•                                |
| :---------: | ----------------------------------- |
| å¢ï¼ˆ1Â æ¡ï¼‰ | await sheet.insert( row1 )          |
| å¢ï¼ˆæ‰¹é‡ï¼‰ | await sheet.insert( row3, row4 )    |
|     æŸ¥     | await sheet.select( )               |
|     æ”¹     | await sheet.update( {'å¹´é¾„': 100} ) |
|     åˆ      | awaitÂ sheet.delete( )              |

## æ¡ä»¶ç­›é€‰

### ç¤ºä¾‹ä¸€ï¼šç†è§£æ¡ä»¶ç­›é€‰çš„åŸºæœ¬èŒƒå¼

ç­›é€‰ã€å¹´é¾„>13ï¼Œä¸”è§†åŠ›â‰§4.6ï¼Œä¸”æ€§åˆ«ä¸ºå¥³ã€‘çš„æ•°æ®ï¼Œå¹¶è¿›è¡ŒæŸ¥æ”¹åˆ ï¼š

**æŸ¥è¯¢**ï¼š`await sheet[mc.å¹´é¾„ > 13][mc.è§†åŠ› >= 4.6][mc.æ€§åˆ« == 'å¥³'].select( )`

**ä¿®æ”¹**ï¼š`await sheet[mc.å¹´é¾„ > 13][mc.è§†åŠ› >= 4.6][mc.æ€§åˆ« == 'å¥³'].update( {'å¹´çº§':'åˆä¸€', 'çˆ±å¥½':'ç”»ç”»,è·³ç»³'} )`

**åˆ é™¤**ï¼š`await sheet[mc.å¹´é¾„ > 13][mc.è§†åŠ› >= 4.6][mc.æ€§åˆ« == 'å¥³'].delete( )`

### ç­›é€‰æ“ä½œæ¸…å•

| **ä»£ç **                                                                 | **è§£é‡Š**                   |
| ------------------------------------------------------------------------------ | -------------------------------- |
| mc.å¹´é¾„ > 10                                                                   | å¤§äº                             |
| mc.å¹´é¾„ >= 10                                                                  | å¤§äºæˆ–ç­‰äº                       |
| mc.å¹´é¾„ < 10                                                                   | å°äº                             |
| mc.å¹´é¾„ <= 10                                                                  | å°äºæˆ–ç­‰äº                       |
| mc.å¹´é¾„ == 10                                                                  | ç­‰äº                             |
| mc.å¹´é¾„ != 10                                                                  | ä¸ç­‰äº                           |
| mc.å¹´çº§.isin( 'åˆä¸‰', 'é«˜äºŒ' )                                                 | è‹¥å­—æ®µå€¼æ˜¯ä¼ å…¥å€¼çš„æˆå‘˜ï¼Œåˆ™ç¬¦åˆ   |
| mc.å¹´é¾„.notin( 10, 30, 45 )                                                    | è‹¥å­—æ®µå€¼ä¸æ˜¯ä¼ å…¥å€¼çš„æˆå‘˜ï¼Œåˆ™ç¬¦åˆ |
| mc.å§“å.re( 'å°', case=True )                                                  | æ­£åˆ™åŒ¹é…ï¼ŒåŒºåˆ†å¤§å°å†™             |
| mc.å§“å.re( 'å°', case=False )                                                 | æ­£åˆ™åŒ¹é…ï¼Œä¸åŒºåˆ†å¤§å°å†™           |
| \[mc.å¹´é¾„ > 3\][mc.å¹´é¾„ < 100]                                                 | äº¤é›†ï¼ˆæ–¹å¼ä¸€ï¼‰                   |
| [ (mc.å¹´é¾„ > 3) & (mc.å¹´é¾„ < 100) ]                                            | äº¤é›†ï¼ˆæ–¹å¼äºŒï¼‰                   |
| [(mc.å¹´é¾„<30)&#124; (mc.å¹´é¾„>30) &#124; (mc.å¹´é¾„==30)Â &#124; (mc.å¹´é¾„==None)] | å¹¶é›†                             |
| [ (mc.å¹´é¾„ > 3) - (mc.å¹´é¾„ > 100) ]                                            | å·®é›†                             |
| [ ~(mc.å¹´é¾„ > 100) ]                                                           | è¡¥é›†                             |

æ³¨ï¼š

1ã€isinã€notin çš„ä¼ å…¥å€¼éƒ½ä¸å¿…æ˜¯åŒç±»å‹çš„æ•°æ®ï¼Œä»¥ isin ä¸ºä¾‹ï¼šå¯ä»¥è¿™æ ·ä½¿ç”¨ï¼šmc.tag.isin( 3, 3.5, 'å­¦ç”Ÿ', None )  ï¼Œä¼ å…¥å€¼å«æœ‰ intã€floatã€strã€NoneType ç­‰å¤šç§ç±»å‹ã€‚

2ã€æˆå‘˜è¿ç®—ç¬¦æœªä¼ å…¥ä»»ä½•å€¼æ—¶çš„å¤„ç†æ–¹å¼ï¼š

| **ä»£ç **   | **å¤„ç†æ–¹å¼** |
| ---------------- | ------------------ |
| mc.å¹´çº§.isin( )  | æ‰€æœ‰æ•°æ®éƒ½ ä¸ç¬¦åˆ  |
| mc.å¹´çº§.notin( ) | æ‰€æœ‰æ•°æ®éƒ½ ç¬¦åˆ    |

3ã€å››ç§é›†åˆè¿ç®—å¯ä»¥ç›¸äº’åµŒå¥—ï¼Œä¸”å¯ä»¥æ— é™åµŒå¥—ã€‚

### ç¤ºä¾‹äºŒï¼šç†è§£å¹¶é›†ã€äº¤é›†ã€å·®é›†çš„ä½¿ç”¨

ç­›é€‰ã€å¹´é¾„>13æˆ–è§†åŠ›â‰§4.6ã€ä¸”å§“åå«æœ‰â€˜å°â€™ã€ä¸”å–œæ¬¢è¶³çƒä½†ä¸å–œæ¬¢ç”»ç”»ã€‘çš„æ•°æ®ï¼š

**æŸ¥è¯¢**ï¼š`await sheet[(mc.å¹´é¾„>13) | (mc.è§†åŠ›>=4.6)][mc.å§“å.re('å°')][mc.çˆ±å¥½.re('è¶³çƒ') - mc.çˆ±å¥½.re('ç”»ç”»')].select( )`

**ä¿®æ”¹**ï¼š`await sheet[(mc.å¹´é¾„>13) | (mc.è§†åŠ›>=4.6)][mc.å§“å.re('å°')][mc.çˆ±å¥½.re('è¶³çƒ') - mc.çˆ±å¥½.re('ç”»ç”»')].update( {'å¹´çº§':'åˆä¸‰'} )`

**åˆ é™¤**ï¼š`await sheet[(mc.å¹´é¾„>13) | (mc.è§†åŠ›>=4.6)][mc.å§“å.re('å°')][mc.çˆ±å¥½.re('è¶³çƒ') - mc.çˆ±å¥½.re('ç”»ç”»')].delete( )`

## ç‰¹æ®Šå­—æ®µåçš„è¡¨ç¤ºæ–¹æ³•

PostgreSQL æ”¯æŒå„ç§ç‰¹æ®Šçš„å­—æ®µåï¼Œå¦‚ï¼šæ•°å­—ã€ç¬¦å·ã€emoji è¡¨æƒ…ï¼Œè¿™äº›å­—ç¬¦åœ¨ Python ä¸­ä¸æ˜¯åˆæ³•å˜é‡åï¼Œå› æ­¤ä½¿ç”¨  mc.1ã€mc.+  ç­‰æ ¼å¼ä¼šæŠ¥é”™ï¼Œå¯ç”¨  mc['1']ã€mc['+']ã€mc['ğŸ‘ˆ']  è¿™ç§æ ¼å¼ä»£æ›¿ã€‚

## åˆ‡ç‰‡

1ã€åˆ‡ç‰‡æ ¼å¼ä¸º  [start: stop: step]  ï¼Œstart è¡¨ç¤ºä»å“ªæ¡å¼€å§‹ï¼Œstop è¡¨ç¤ºåˆ°å“ªæ¡åœæ­¢ï¼Œstep è¡¨ç¤ºæ­¥é•¿ã€‚

2ã€start å’Œ stop

* é¡»ä¸ºæ­£æ•´æ•°ã€‚
* è¡¨ç¤ºæ­£åºç¬¬ x æ¡ï¼Œä¾‹å¦‚ï¼š1 è¡¨ç¤ºç¬¬ 1 æ¡ã€2 è¡¨ç¤ºç¬¬ 2 æ¡ã€‚

3ã€step

* é¡»ä¸ºæ­£æ•´æ•°ã€‚
* å½“ step â‰§ 2  æ—¶è¡¨ç¤ºé—´éš”å¼åˆ‡ç‰‡ã€‚
* å½“ step = 1 æ—¶å¯çœç•¥ `: step` ï¼Œå³ï¼š[start: stop] ç­‰ä»·äº [start: stop: 1] ã€‚

### ç¤ºä¾‹

```python
await sheet[è¿‡æ»¤å™¨]...[è¿‡æ»¤å™¨][:].select()                    # æŸ¥è¯¢ç¬¦åˆæ¡ä»¶çš„å…¨éƒ¨æ•°æ®
await sheet[è¿‡æ»¤å™¨]...[è¿‡æ»¤å™¨][:].delete()                    # åˆ é™¤ç¬¦åˆæ¡ä»¶çš„å…¨éƒ¨æ•°æ®
await sheet[è¿‡æ»¤å™¨]...[è¿‡æ»¤å™¨][:].update({'å¹´çº§':'åˆä¸€'})      # ä¿®æ”¹ç¬¦åˆæ¡ä»¶çš„å…¨éƒ¨æ•°æ®

await sheet[è¿‡æ»¤å™¨]...[è¿‡æ»¤å™¨][1].select()                    # æŸ¥è¯¢ç¬¦åˆæ¡ä»¶çš„ç¬¬1æ¡
await sheet[è¿‡æ»¤å™¨]...[è¿‡æ»¤å™¨][1].delete()                    # åˆ é™¤ç¬¦åˆæ¡ä»¶çš„ç¬¬1æ¡
await sheet[è¿‡æ»¤å™¨]...[è¿‡æ»¤å™¨][1].update({'å¹´çº§':'åˆä¸€'})      # ä¿®æ”¹ç¬¦åˆæ¡ä»¶çš„ç¬¬1æ¡

await sheet[è¿‡æ»¤å™¨]...[è¿‡æ»¤å™¨][3:7].select()                  # æŸ¥è¯¢ç¬¦åˆæ¡ä»¶çš„ç¬¬3~7æ¡
await sheet[è¿‡æ»¤å™¨]...[è¿‡æ»¤å™¨][3:7].delete()                  # åˆ é™¤ç¬¦åˆæ¡ä»¶çš„ç¬¬3~7æ¡
await sheet[è¿‡æ»¤å™¨]...[è¿‡æ»¤å™¨][3:7].update({'å¹´çº§':'åˆä¸€'})    # ä¿®æ”¹ç¬¦åˆæ¡ä»¶çš„ç¬¬3~7æ¡

await sheet[è¿‡æ»¤å™¨]...[è¿‡æ»¤å™¨][3:7:2].select()                # æŸ¥è¯¢ç¬¦åˆæ¡ä»¶çš„ç¬¬3ã€5ã€7æ¡
await sheet[è¿‡æ»¤å™¨]...[è¿‡æ»¤å™¨][3:7:2].delete()                # åˆ é™¤ç¬¦åˆæ¡ä»¶çš„ç¬¬3ã€5ã€7æ¡
await sheet[è¿‡æ»¤å™¨]...[è¿‡æ»¤å™¨][3:7:2].update({'å¹´çº§':'åˆä¸€'})  # ä¿®æ”¹ç¬¦åˆæ¡ä»¶çš„ç¬¬3ã€5ã€7æ¡
```

å€¼å¾—æ³¨æ„çš„åœ°æ–¹ï¼š  [3: 8: 2]  æ“ä½œç¬¬  3ã€5ã€7  æ¡ï¼Œè€Œ  [8: 3: 2]  æ“ä½œç¬¬  8ã€6ã€4  æ¡ã€‚

æ›´å¤šç¤ºä¾‹ï¼š

```python
[:]           # æ‰€æœ‰æ•°æ®
[1:]          # æ‰€æœ‰æ•°æ®
[:1000]       # ç¬¬1æ¡ ~ ç¬¬1000æ¡
[100:200]     # ç¬¬100æ¡ ~ ç¬¬200æ¡
[200:100]     # ç¬¬200æ¡ ~ ç¬¬100æ¡
[250:]        # ç¬¬250æ¡ ~ æœ€å1æ¡
[1]           # ç¬¬1æ¡
[::3]         # ä»¥3ä¸ºé—´è·, é—´éš”æ“ä½œæ‰€æœ‰æ•°æ®
[100:200:4]   # ä»¥4ä¸ºé—´è·, é—´éš”æ“ä½œç¬¬100æ¡ ~ ç¬¬200æ¡
```

## å­—æ®µæç¤º

å˜é‡ mc æ— å­—æ®µæç¤ºåŠŸèƒ½ï¼Œè¾“å…¥â€˜mc.â€™åï¼Œç¼–è¾‘å™¨ä¸ä¼šæç¤ºå¯é€‰å­—æ®µã€‚

ä¸ºäº†è·å¾—å­—æ®µæç¤ºåŠŸèƒ½ï¼Œå¯è‡ªå»ºä¸€ä¸ªâ€˜mc2â€™ï¼š

```python
class mc2(mc):
    å§“å = å¹´é¾„ = ç­¾åˆ°æ—¥æœŸ = å¹´çº§ = çˆ±å¥½ = None

await sheet[mc.å§“å == 'å°ç‹'][mc2.å¹´é¾„ > 10].select()
```

æ³¨ï¼š

1ã€mc2 ä¸ mc ç”¨æ³•å®Œå…¨ä¸€è‡´ï¼Œå¯æ··ç”¨ã€‚

2ã€mc2 è®¾ç½®å­—æ®µæç¤ºåï¼Œä»…å…·å¤‡æç¤ºæ•ˆæœï¼Œè€Œä¸äº§ç”Ÿä»»ä½•å®é™…çº¦æŸã€‚

## æ’åº

å¯¹æ‰€æœ‰å¹´çº§ä¸ºâ€œé«˜ä¸€â€çš„æ•°æ®ï¼Œä¼˜å…ˆæŒ‰å¹´é¾„é™åºï¼Œå…¶æ¬¡æŒ‰å§“åå‡åºï¼Œæ’åºåè¿”å›ç¬¬ 2\~4 æ¡æ•°æ®ï¼š

```python
await sheet[mc.å¹´çº§=='é«˜ä¸€'].order(å¹´é¾„=False, å§“å=True)[2:4].select()
```

æœ‰è¶£çš„ï¼Œä»¥ä¸‹ä¸¤è¡Œä»£ç çš„è¿”å›ç»“æœç›¸åŒï¼š

```python
await sheet[mc.å¹´çº§=='é«˜ä¸€'].order(å¹´é¾„=True)[1:-1].select()

await sheet[mc.å¹´çº§=='é«˜ä¸€'].order(å¹´é¾„=False)[-1:1].select()
```

è§£é‡Šï¼šorder(å¹´é¾„=False) è¡¨ç¤ºæŒ‰å¹´é¾„é™åºï¼Œ[-1:1] è¡¨ç¤ºé€†åºåˆ‡ç‰‡ï¼Œäº§ç”Ÿäº†ç±»ä¼¼â€˜è´Ÿè´Ÿå¾—æ­£â€™çš„æ•ˆæœã€‚

æ³¨ï¼š

1ã€ç­›é€‰å™¨ã€åˆ‡ç‰‡å™¨ã€æ’åºå™¨ã€é™å®šå­—æ®µå™¨çš„ä½ç½®å¯ä»»æ„ï¼Œä½ç½®ä¸å½±å“å…¶æ•ˆæœã€‚å½“ç„¶ï¼Œå®ƒä»¬éƒ½åº”è¯¥åœ¨ sheet ä¹‹åï¼Œä¸”åœ¨ select/update/delete ä¹‹å‰ã€‚

2ã€å¯åå¤æ’åºï¼Œselect/update/delete æ—¶æ˜¯æ ¹æ®æœ€åä¸€æ¬¡æŒ‡å®šçš„é¡ºåºæå–æ•°æ®ã€‚ä»¥ä¸‹ä»£ç æœ€ç»ˆæ˜¯æŒ‰å¹´é¾„é™åºåæå–æ•°æ®ï¼š

```python
await sheet.order(å¹´é¾„=True, å§“å=False).order(å¹´é¾„=False).select()
```

3ã€è‹¥æƒ³å–æ¶ˆæ’åºï¼Œåˆ™å†æ¬¡è°ƒç”¨ order æ–¹æ³•ï¼Œä½†ä¸ä¼ å…¥ä»»ä½•å€¼ã€‚

```python
await sheet.order(å¹´é¾„=True, å§“å=False).order().select()
```

## é™å®šå­—æ®µ

åªè¿”å›å§“åã€å¹´é¾„è¿™ä¸¤ä¸ªå­—æ®µï¼š

```python
await sheet[mc.å¹´çº§=='é«˜ä¸€']['å§“å','å¹´é¾„'].select()
```

æ³¨ï¼š

1ã€é™å®šå­—æ®µåªå¯¹ select æœ‰ä½œç”¨ï¼Œå¯¹ update/delete æ— ä½œç”¨ä½†ä¸ä¼šæŠ¥é”™ã€‚

2ã€ç­›é€‰å™¨ã€åˆ‡ç‰‡å™¨ã€æ’åºå™¨ã€é™å®šå­—æ®µå™¨çš„ä½ç½®å¯ä»»æ„ï¼Œä½ç½®ä¸å½±å“å…¶æ•ˆæœã€‚å½“ç„¶ï¼Œå®ƒä»¬éƒ½åº”è¯¥åœ¨ sheet ä¹‹åï¼Œä¸”åœ¨ select/update/delete ä¹‹å‰ã€‚

3ã€å¯åå¤é™å®šå­—æ®µï¼ŒæŸ¥è¯¢æ—¶æ˜¯æ ¹æ®æœ€åä¸€æ¬¡æŒ‡å®šçš„å­—æ®µæå–æ•°æ®ã€‚ä»¥ä¸‹ä»£ç è¿”å›ç»“æœä¸­åªæœ‰â€˜å¹´é¾„â€™å­—æ®µï¼š

```python
await sheet[mc.å¹´çº§=='é«˜ä¸€']['å§“å']['å¹´é¾„'].select()
```

4ã€è‹¥æƒ³æ¢å¤æå–å…¨éƒ¨å­—æ®µï¼Œåˆ™é™å®šå­—æ®µä¸º `'*'` ï¼Œ`'*'` å³ä»£è¡¨â€œå…¨éƒ¨å­—æ®µâ€ã€‚

```python
await sheet[mc.å¹´çº§=='é«˜ä¸€']['å§“å']['*'].select()
```

## ç»Ÿè®¡

| åŠŸèƒ½                   | æ–¹å¼                              |
| ---------------------- | --------------------------------- |
| ç»Ÿè®¡è¡¨çš„æ•°é‡           | await db.len( )                   |
| ç»Ÿè®¡è¡Œçš„æ•°é‡           | await sheet.len( )                |
| ç»Ÿè®¡ç¬¦åˆæ¡ä»¶çš„è¡Œçš„æ•°é‡ | await sheet[ mc.age > 8Â ].len( ) |
| è·å–è¡¨åæ¸…å•           | await db.get_sheet_names( )       |
| è·å–ä¸»é”®               | await sheet.get_pk( )             |

## è¿­ä»£æ‰€æœ‰è¡¨ORM

```python
async for sheet in db:
    print(sheet.sheet_name)
```

## æ‰§è¡ŒåŸç”Ÿ SQL è¯­å¥

```python
await sheet.execute('select å§“å from å¸Œæœ›å°å­¦ limit 1')
# >>> [{'å§“å': 'å°ä¸€'}]

await sheet.execute("update å¸Œæœ›å°å­¦ set çˆ±å¥½='ç¼–ç¨‹' limit 3")

await sheet.execute("delete from å¸Œæœ›å°å­¦ limit 2")
```
